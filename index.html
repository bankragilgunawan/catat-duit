<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Catatan Keuangan</title>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <style>
    :root {
      --warna-bg: #fff;
      --warna-teks: #000;
      --warna-primer: #4caf50;
    }

    [data-tema="gelap"] {
      --warna-bg: #121212;
      --warna-teks: #fff;
      --warna-primer: #81c784;
    }

    body {
      margin: 0;
      font-family: sans-serif;
      background: var(--warna-bg);
      color: var(--warna-teks);
    }

    header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      background: var(--warna-primer);
      padding: 10px;
      color: #fff;
    }

    header h1 {
      flex: 1;
      text-align: center;
      margin: 0 10px;
    }

    #pinOverlay {
      position: fixed;
      inset: 0;
      background: rgba(0,0,0,0.8);
      display: flex;
      flex-direction: column;
      justify-content: center;
      align-items: center;
      z-index: 99;
    }

    #pinOverlay input, #pinOverlay button {
      padding: 10px;
      margin: 5px;
      font-size: 1.2em;
      border-radius: 8px;
      border: none;
      box-shadow: 0 2px 5px rgba(0,0,0,0.2);
    }

    main {
      padding: 15px;
      max-width: 600px;
      margin: auto;
    }

    input, select, button {
      width: 100%;
      padding: 10px;
      margin-top: 8px;
      border-radius: 6px;
      border: 1px solid #ccc;
      font-size: 1em;
    }

    .fab {
      position: fixed;
      bottom: 20px;
      right: 20px;
      background: var(--warna-primer);
      color: #fff;
      font-size: 20px;
      padding: 12px 20px;
      border-radius: 30px;
      box-shadow: 0 4px 10px rgba(0,0,0,0.3);
      border: none;
    }

    #ringkasan {
      background: #e3f2fd;
      padding: 10px;
      border-radius: 10px;
      margin: 15px 0;
      box-shadow: 0 2px 8px rgba(0,0,0,0.05);
    }

    #riwayat div {
      background: #f1f1f1;
      margin: 5px 0;
      padding: 10px;
      border-radius: 8px;
    }

    .tema-toggle {
      font-size: 1.3em;
      background: none;
      border: none;
      color: white;
      cursor: pointer;
    }

    canvas {
      margin-top: 20px;
    }
  </style>
</head>
<body data-tema="terang">
  <div id="pinOverlay">
    <input type="password" id="pinInput" placeholder="Masukkan PIN" />
    <button onclick="cekPIN()">Masuk</button>
  </div>

  <header>
    <img src="https://img.icons8.com/emoji/48/money-bag-emoji.png" width="32" height="32" alt="logo" />
    <h1>Catatan Keuangan</h1>
    <button class="tema-toggle" onclick="toggleTema()" title="Ganti Tema">ðŸŒž</button>
  </header>

  <main>
    <div id="ringkasan">
      <strong>Ringkasan Bulan Ini:</strong>
      <div id="totalMasuk">Pemasukan: Rp0</div>
      <div id="totalKeluar">Pengeluaran: Rp0</div>
      <div id="saldo">Saldo: Rp0</div>
    </div>

    <form id="formTransaksi">
      <input type="text" id="judul" placeholder="Judul transaksi" required />
      <input type="number" id="jumlah" placeholder="Jumlah (positif/negatif)" required />
      <input type="date" id="tanggal" required />
      <button type="submit">Catat</button>
    </form>

    <canvas id="grafikBulanan" height="200"></canvas>

    <section id="riwayat">
      <h3>Riwayat Transaksi</h3>
      <!-- Transaksi tampil di sini -->
    </section>

    <button onclick="ekspor('json')">Ekspor JSON</button>
    <button onclick="ekspor('csv')">Ekspor CSV</button>
  </main>

  <button class="fab" onclick="document.getElementById('formTransaksi').scrollIntoView({behavior:'smooth'})">+ Catat</button>

  <script>
    const data = JSON.parse(localStorage.getItem("keuangan") || "[]");
    const pinSimpan = localStorage.getItem("pin") || "1234";
    const tema = localStorage.getItem("tema") || "terang";
    document.body.dataset.tema = tema;
    document.querySelector(".tema-toggle").textContent = tema === "gelap" ? "ðŸŒ™" : "ðŸŒž";

    function cekPIN() {
      const pin = document.getElementById("pinInput").value;
      if (pin === pinSimpan) {
        document.getElementById("pinOverlay").style.display = "none";
        tampilkanSemua();
      } else {
        alert("PIN salah!");
      }
    }

    function toggleTema() {
      const sekarang = document.body.dataset.tema;
      const baru = sekarang === "gelap" ? "terang" : "gelap";
      document.body.dataset.tema = baru;
      localStorage.setItem("tema", baru);
      document.querySelector(".tema-toggle").textContent = baru === "gelap" ? "ðŸŒ™" : "ðŸŒž";
    }

    function catatTransaksi(e) {
      e.preventDefault();
      const judul = document.getElementById("judul").value.trim();
      const jumlah = parseFloat(document.getElementById("jumlah").value);
      const tanggal = document.getElementById("tanggal").value;
      if (!judul || isNaN(jumlah) || !tanggal) return alert("Isi semua kolom dengan benar!");

      data.push({ judul, jumlah, tanggal });
      localStorage.setItem("keuangan", JSON.stringify(data));
      e.target.reset();
      tampilkanSemua();
    }

    function tampilkanSemua() {
      const bulanIni = new Date().toISOString().slice(0, 7);
      const dataBulanIni = data.filter(d => d.tanggal.slice(0, 7) === bulanIni);
      const masuk = dataBulanIni.filter(d => d.jumlah > 0).reduce((a,b)=>a+b.jumlah,0);
      const keluar = dataBulanIni.filter(d => d.jumlah < 0).reduce((a,b)=>a+b.jumlah,0);
      document.getElementById("totalMasuk").textContent = "Pemasukan: Rp" + masuk.toLocaleString();
      document.getElementById("totalKeluar").textContent = "Pengeluaran: Rp" + Math.abs(keluar).toLocaleString();
      document.getElementById("saldo").textContent = "Saldo: Rp" + (masuk + keluar).toLocaleString();
      lihatRiwayat(dataBulanIni);
      tampilkanGrafik();
    }

    function lihatRiwayat(dataTampil) {
      const r = document.getElementById("riwayat");
      r.innerHTML = "<h3>Riwayat Transaksi</h3>";
      dataTampil.slice().reverse().forEach(d => {
        r.innerHTML += `<div><strong>${d.judul}</strong><br>Rp${d.jumlah.toLocaleString()}<br><small>${new Date(d.tanggal).toLocaleDateString("id-ID")}</small></div>`;
      });
    }

    function ekspor(format) {
      let file = "";
      if (format === "json") {
        file = "data:application/json," + encodeURIComponent(JSON.stringify(data));
        download(file, "catatan-keuangan.json");
      } else if (format === "csv") {
        const header = "Judul,Jumlah,Tanggal\n";
        const rows = data.map(d => `${d.judul},${d.jumlah},${d.tanggal}`).join("\n");
        file = "data:text/csv," + encodeURIComponent(header + rows);
        download(file, "catatan-keuangan.csv");
      }
    }

    function download(href, filename) {
      const a = document.createElement("a");
      a.href = href;
      a.download = filename;
      a.click();
    }

    function tampilkanGrafik() {
      const ctx = document.getElementById("grafikBulanan");
      const bulanan = {};
      data.forEach(d => {
        const bulan = d.tanggal.slice(0, 7);
        if (!bulanan[bulan]) bulanan[bulan] = 0;
        bulanan[bulan] += d.jumlah;
      });
      const label = Object.keys(bulanan).sort();
      const nilai = label.map(l => bulanan[l]);

      if (window.grafik) window.grafik.destroy();
      if (label.length === 0) {
        ctx.style.display = "none";
        return;
      } else {
        ctx.style.display = "block";
      }

      window.grafik = new Chart(ctx, {
        type: "bar",
        data: {
          labels: label,
          datasets: [{
            label: "Saldo Bulanan",
            data: nilai,
            backgroundColor: "rgba(76, 175, 80, 0.5)",
            borderColor: "rgba(76, 175, 80, 1)",
            borderWidth: 1
          }]
        },
        options: {
          responsive: true,
          scales: {
            y: { beginAtZero: true }
          }
        }
      });
    }

    document.getElementById("formTransaksi").addEventListener("submit", catatTransaksi);
  </script>
</body>
</html>
